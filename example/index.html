<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Form validation</title>
   
</head>
<body>
	<h2>Insert email</h2>
  <input type="text" value="" placeholder="email" id="email" />
  <input type="submit" id="submit" />

  

  <script src="../code.js"></script>
  <script>
  'use strict'
  	
  	//Original functionality
	var RPC = function(){};

	RPC.prototype.rpcCall = function(func, argArr, cb, due){
		var email = argArr[0];
		if(email.indexOf('@') === -1){
			cb(new Error('E'));
		}else{
			cb(null, email);
		}
	};
	RPC.prototype.getState = function(){};
	RPC.prototype.setState = function(){};

	//application proxy
	var makeApplicationProxy = function(target){
	    return makeJSProxy(target, {
	        rpcCall: function(originalCall, args, context, subject){
	        	var foreignFunc = args[0]; 
	        	var foreignFuncArgs = args[1]; 
	        	var cb = args[2]; 

	        	args[2] = function(err, res){
	        		console.log('cb instumented');
	        		return cb(err, res);
	        	}

	            return originalCall.apply(context, args);
	        }
	    });
	};

	//log proxy
	var makeLogProxy = function(target){
   		var counter = 0;
    	return makeJSProxy(target, {
	        rpcCall: function(originalCall, args, context, subject){
	        	counter++;
	        	//that.counter++;
	        	console.log('Log ', counter, ': ', context, subject);
	        	
	            return originalCall.apply(context, args);
	        }
	    });
	};

	//application code
	var email = document.getElementById('email');
	var button = document.getElementById('submit');

	var r = new RPC();
	var l = makeApplicationProxy(makeLogProxy(r));
	
	button.addEventListener('click', function(){

		//r.rpcCall('validateEmail', [email.value], function(err, res){  // original
		l.rpcCall('validateEmail', [email.value], function(err, res){	//new	
			if(err){
				alert('validation failed: ' + err);
			} else{
				alert('validation succeeded: ' + res);
			}
			
			return res;
		});
		
	});
  </script>
</body>
</html>